# 量化策略回测可视化网站 - 技术架构设计文档

## 1. 架构设计

```mermaid
graph TD
    A[用户浏览器] --> B[React前端应用]
    B --> C[Nginx反向代理]
    C --> D[FastAPI后端服务]
    D --> E[Celery任务队列]
    D --> F[Redis缓存层]
    D --> G[PostgreSQL数据库]
    D --> H[本地文件系统]
    E --> I[回测计算引擎]
    
    subgraph "前端层"
        B
    end
    
    subgraph "网关层"
        C
    end
    
    subgtml "后端层"
        D
        E
        F
    end
    
    subgraph "数据层"
        G
        H
    end
    
    subgraph "计算层"
        I
    end
```

## 2. 技术描述

**前端技术栈：**

* React\@18 + TypeScript + Vite

* TradingView Charting Library（专业金融图表）

* Ant Design + Tailwind CSS

* Zustand（状态管理）

* React Query + Axios（数据请求）

**后端技术栈：**

* FastAPI\@0.104（高性能异步API框架）

* Celery\@5.3（分布式任务队列）

* pandas\@2.1 + numpy\@1.24（数据处理）

* SQLAlchemy\@2.0（ORM框架）

**基础设施：**

* Nginx（反向代理和静态文件服务）

* Redis\@7.0（缓存和消息队列）

* PostgreSQL\@15（主数据库）

## 3. 数据服务

* **PostgreSQL**：存储用户数据、回测配置、回测结果、交易记录

* **Redis**：缓存K线数据、回测进度、会话信息

* **本地文件系统**：存储原始K线数据文件（.h5格式）

* **Supabase**：用户认证和权限管理（可选）

## 4. API定义

### 4.1 核心API

**回测管理相关**

```
POST /api/v1/backtest/start
```

请求：

| 参数名称             | 参数类型   | 是否必需  | 描述     |
| ---------------- | ------ | ----- | ------ |
| strategy\_config | object | true  | 策略配置参数 |
| backtest\_config | object | true  | 回测配置参数 |
| market\_config   | object | false | 市场配置参数 |

响应：

| 参数名称     | 参数类型   | 描述       |
| -------- | ------ | -------- |
| task\_id | string | 回测任务唯一标识 |
| status   | string | 任务状态     |

示例：

```json
{
  "strategy_config": {
    "leverage": 125,
    "spread": 0.004,
    "atr_threshold": 0.30,
    "hedge_mode": true
  },
  "backtest_config": {
    "start_date": "2020-01-01",
    "end_date": "2020-05-20",
    "initial_balance": 1000
  }
}
```

**获取回测进度**

```
GET /api/v1/backtest/progress/{task_id}
```

响应：

| 参数名称          | 参数类型   | 描述           |
| ------------- | ------ | ------------ |
| progress      | number | 进度百分比（0-100） |
| status        | string | 当前状态         |
| current\_step | string | 当前执行步骤       |
| eta           | number | 预计剩余时间（秒）    |

**获取回测结果**

```
GET /api/v1/backtest/result/{task_id}
```

响应：

| 参数名称                 | 参数类型   | 描述     |
| -------------------- | ------ | ------ |
| equity\_curve        | array  | 资金曲线数据 |
| trade\_history       | array  | 交易历史记录 |
| performance\_metrics | object | 绩效指标   |
| risk\_metrics        | object | 风险指标   |

### 4.2 K线数据API

**获取K线数据**

```
GET /api/v1/klines
```

请求：

| 参数名称        | 参数类型   | 是否必需  | 描述             |
| ----------- | ------ | ----- | -------------- |
| symbol      | string | true  | 交易对符号          |
| start\_date | string | true  | 开始日期           |
| end\_date   | string | true  | 结束日期           |
| timeframe   | string | false | 时间周期（1m/1h/1d） |

响应：

| 参数名称   | 参数类型   | 描述               |
| ------ | ------ | ---------------- |
| klines | array  | K线数据数组           |
| count  | number | 数据条数             |
| source | string | 数据来源（cache/file） |

### 4.3 交易标记API

**获取交易标记**

```
GET /api/v1/trades/markers/{task_id}
```

响应：

| 参数名称    | 参数类型  | 描述     |
| ------- | ----- | ------ |
| markers | array | 交易标记数组 |

交易标记格式：

```json
{
  "time": 1577836800,
  "position": "aboveBar",
  "color": "#2196F3",
  "shape": "arrowUp",
  "text": "开多 0.5 ETH @ 130.25",
  "size": 1
}
```

## 5. 服务器架构图

```mermaid
graph TD
    A[客户端/前端] --> B[控制器层]
    B --> C[服务层]
    C --> D[数据访问层]
    D --> E[(数据库)]
    
    B --> F[任务队列]
    F --> G[回测计算服务]
    
    C --> H[缓存层]
    H --> I[(Redis)]
    
    subgraph "FastAPI应用服务器"
        B
        C
        D
    end
    
    subgraph "异步任务处理"
        F
        G
    end
```

## 6. 数据模型

### 6.1 数据模型定义

```mermaid
erDiagram
    USER ||--o{ BACKTEST_CONFIG : creates
    BACKTEST_CONFIG ||--o{ BACKTEST_RESULT : generates
    BACKTEST_RESULT ||--|{ TRADE_RECORD : contains
    BACKTEST_RESULT ||--|| EQUITY_CURVE : has
    BACKTEST_RESULT ||--|| PERFORMANCE_METRICS : has
    
    USER {
        uuid id PK
        string email
        string name
        timestamp created_at
    }
    
    BACKTEST_CONFIG {
        uuid id PK
        uuid user_id FK
        string strategy_name
        jsonb strategy_params
        jsonb market_params
        date start_date
        date end_date
        decimal initial_balance
        timestamp created_at
    }
    
    BACKTEST_RESULT {
        uuid id PK
        uuid config_id FK
        string status
        decimal final_balance
        decimal max_drawdown
        decimal total_return
        integer total_trades
        timestamp completed_at
    }
    
    TRADE_RECORD {
        uuid id PK
        uuid result_id FK
        timestamp trade_time
        string trade_type
        string side
        decimal quantity
        decimal price
        decimal fee
        decimal pnl
    }
    
    EQUITY_CURVE {
        uuid id PK
        uuid result_id FK
        jsonb curve_data
        jsonb drawdown_data
    }
    
    PERFORMANCE_METRICS {
        uuid id PK
        uuid result_id FK
        decimal sharpe_ratio
        decimal win_rate
        decimal profit_factor
        decimal max_consecutive_losses
        jsonb detailed_metrics
    }
```

### 6.2 数据定义语言

**用户表 (users)**

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at DESC);
```

**回测配置表 (backtest\_configs)**

```sql
CREATE TABLE backtest_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    strategy_name VARCHAR(100) NOT NULL,
    strategy_params JSONB NOT NULL,
    market_params JSONB DEFAULT '{}',
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    initial_balance DECIMAL(15,2) NOT NULL CHECK (initial_balance > 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_backtest_configs_user_id ON backtest_configs(user_id);
CREATE INDEX idx_backtest_configs_created_at ON backtest_configs(created_at DESC);
CREATE INDEX idx_backtest_configs_strategy ON backtest_configs(strategy_name);
```

**回测结果表 (backtest\_results)**

```sql
CREATE TABLE backtest_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_id UUID REFERENCES backtest_configs(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'running', 'completed', 'failed')),
    final_balance DECIMAL(15,2),
    max_drawdown DECIMAL(8,4),
    total_return DECIMAL(8,4),
    total_trades INTEGER DEFAULT 0,
    error_message TEXT,
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_backtest_results_config_id ON backtest_results(config_id);
CREATE INDEX idx_backtest_results_status ON backtest_results(status);
CREATE INDEX idx_backtest_results_completed_at ON backtest_results(completed_at DESC);
```

**交易记录表 (trade\_records)**

```sql
CREATE TABLE trade_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    result_id UUID REFERENCES backtest_results(id) ON DELETE CASCADE,
    trade_time TIMESTAMP WITH TIME ZONE NOT NULL,
    trade_type VARCHAR(20) NOT NULL CHECK (trade_type IN ('buy_long', 'sell_long', 'sell_short', 'buy_short')),
    side VARCHAR(10) NOT NULL CHECK (side IN ('long', 'short')),
    quantity DECIMAL(18,8) NOT NULL CHECK (quantity > 0),
    price DECIMAL(15,2) NOT NULL CHECK (price > 0),
    fee DECIMAL(15,8) NOT NULL DEFAULT 0,
    pnl DECIMAL(15,8) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_trade_records_result_id ON trade_records(result_id);
CREATE INDEX idx_trade_records_trade_time ON trade_records(trade_time);
CREATE INDEX idx_trade_records_trade_type ON trade_records(trade_type);
```

**资金曲线表 (equity\_curves)**

```sql
CREATE TABLE equity_curves (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    result_id UUID REFERENCES backtest_results(id) ON DELETE CASCADE,
    curve_data JSONB NOT NULL,
    drawdown_data JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_equity_curves_result_id ON equity_curves(result_id);
```

**绩效指标表 (performance\_metrics)**

```sql
CREATE TABLE performance_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    result_id UUID REFERENCES backtest_results(id) ON DELETE CASCADE,
    sharpe_ratio DECIMAL(8,4),
    win_rate DECIMAL(8,4),
    profit_factor DECIMAL(8,4),
    max_consecutive_losses INTEGER,
    avg_trade_duration INTERVAL,
    detailed_metrics JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_performance_metrics_result_id ON performance_metrics(result_id);
```

**初始化数据**

```sql
-- 创建演示用户
INSERT INTO users (email, name) VALUES 
('demo@quantbot.com', '演示用户'),
('trader@quantbot.com', '量化交易员');

-- 创建默认回测配置
INSERT INTO backtest_configs (user_id, strategy_name, strategy_params, start_date, end_date, initial_balance)
SELECT 
    u.id,
    '对冲网格策略',
    '{
        "leverage": 125,
        "spread": 0.004,
        "atr_threshold": 0.30,
        "hedge_mode": true,
        "position_size_ratio": 1.0
    }',
    '2020-01-01',
    '2020-05-20',
    1000.00
FROM users u WHERE u.email = 'demo@quantbot.com';

-- 创建保守型配置模板
INSERT INTO backtest_configs (user_id, strategy_name, strategy_params, start_date, end_date, initial_balance)
SELECT 
    u.id,
    '对冲网格策略-保守型',
    '{
        "leverage": 50,
        "spread": 0.006,
        "atr_threshold": 0.20,
        "hedge_mode": true,
        "position_size_ratio": 0.8
    }',
    '2020-01-01',
    '2020-05-20',
    1000.00
FROM users u WHERE u.email = 'demo@quantbot.com';
```

## 7. 部署架构

### 7.1 开发环境

```bash
# 前端开发服务器
npm run dev  # http://localhost:3000

# 后端开发服务器
uvicorn main:app --reload --port 8000

# Redis服务
redis-server --port 6379

# PostgreSQL服务
psql -U postgres -d quantbot_dev

# Celery工作进程
celery -A app.celery worker --loglevel=info
```

### 7.2 生产环境

```bash
# 使用Docker Compose部署
docker-compose up -d

# 或使用Kubernetes部署
kubectl apply -f k8s/
```

### 7.3 环境配置

```env
# .env.production
DATABASE_URL=postgresql://user:pass@localhost:5432/quantbot
REDIS_URL=redis://localhost:6379/0
CELERY_BROKER_URL=redis://localhost:6379/1
SECRET_KEY=your-secret-key
CORS_ORIGINS=https://quantbot.com
```

