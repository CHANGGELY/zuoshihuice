# 前端重构实现指南

## 1. 项目结构重构

### 1.1 新的目录结构

```
src/
├── components/           # 通用组件
│   ├── common/          # 基础组件
│   │   ├── Loading.tsx
│   │   ├── ErrorBoundary.tsx
│   │   └── Header.tsx
│   ├── charts/          # 图表组件
│   │   ├── TradingViewChart.tsx
│   │   ├── EquityCurveChart.tsx
│   │   └── SignalMarkers.tsx
│   └── forms/           # 表单组件
│       ├── StrategyConfigForm.tsx
│       └── DateRangePicker.tsx
├── pages/               # 页面组件
│   ├── KlineChartPage.tsx
│   └── BacktestResultPage.tsx
├── stores/              # 状态管理
│   ├── klineStore.ts
│   ├── backtestStore.ts
│   └── uiStore.ts
├── services/            # API服务
│   ├── api.ts
│   ├── klineService.ts
│   └── backtestService.ts
├── types/               # 类型定义
│   ├── kline.ts
│   ├── strategy.ts
│   └── backtest.ts
├── utils/               # 工具函数
│   ├── formatters.ts
│   ├── validators.ts
│   └── constants.ts
├── hooks/               # 自定义Hook
│   ├── useKlineData.ts
│   ├── useBacktest.ts
│   └── useWebSocket.ts
└── styles/              # 样式文件
    ├── globals.css
    └── components.css
```

## 2. 核心组件实现

### 2.1 K线图表页面 (KlineChartPage.tsx)

**功能要求：**
- 显示基于H5文件的历史K线数据
- 集成TradingView图表库
- 右侧策略配置面板
- 交易信号标记显示
- 实时回测状态更新

**关键特性：**
- 响应式布局：左侧图表区域，右侧配置面板
- 图表缩放和时间范围选择
- 策略参数实时验证
- 回测进度显示

### 2.2 回测结果页面 (BacktestResultPage.tsx)

**功能要求：**
- 回测概览指标展示
- 资金曲线图表
- 交易记录表格
- 持仓历史可视化

**关键特性：**
- 多图表联动显示
- 交易记录分页和筛选
- 性能指标卡片布局
- 导出功能支持

### 2.3 TradingView图表组件 (TradingViewChart.tsx)

**技术要求：**
- 集成TradingView Charting Library
- 支持K线数据实时更新
- 自定义交易信号标记
- 深色主题适配

**实现要点：**
```typescript
// 图表配置
const chartConfig = {
  theme: 'dark',
  locale: 'zh',
  timezone: 'Asia/Shanghai',
  symbol: 'ETHUSDT',
  interval: '1m',
  container_id: 'tradingview_chart',
  datafeed: customDatafeed,
  library_path: '/charting_library/',
  charts_storage_url: 'https://saveload.tradingview.com',
  charts_storage_api_version: '1.1',
  client_id: 'tradingview.com',
  user_id: 'public_user_id',
  fullscreen: false,
  autosize: true,
  studies_overrides: {},
  overrides: {
    'paneProperties.background': '#1a1a1a',
    'paneProperties.vertGridProperties.color': '#2d2d2d',
    'paneProperties.horzGridProperties.color': '#2d2d2d',
  }
};
```

### 2.4 策略配置表单 (StrategyConfigForm.tsx)

**表单字段：**
- 基本信息：策略名称、描述
- ATR配置：波动率自适应、ATR周期、波动率阈值
- 策略参数：杠杆倍数、价差、仓位比例
- 风险控制：仓位平衡、紧急平仓设置
- 回测参数：初始资金、时间范围

**验证规则：**
- 实时参数验证
- 错误提示显示
- 警告信息展示
- 参数范围检查

## 3. 状态管理设计

### 3.1 K线数据状态 (klineStore.ts)

```typescript
interface KlineState {
  data: KlineData[];
  loading: boolean;
  error: string | null;
  symbol: string;
  timeframe: string;
  dateRange: [string, string];
}

interface KlineActions {
  fetchKlineData: (params: KlineParams) => Promise<void>;
  updateSymbol: (symbol: string) => void;
  updateTimeframe: (timeframe: string) => void;
  updateDateRange: (range: [string, string]) => void;
  clearError: () => void;
}
```

### 3.2 回测状态 (backtestStore.ts)

```typescript
interface BacktestState {
  currentBacktest: BacktestResult | null;
  backtestHistory: BacktestResult[];
  isRunning: boolean;
  progress: number;
  error: string | null;
  strategyConfig: StrategyConfig;
}

interface BacktestActions {
  startBacktest: (request: BacktestRequest) => Promise<void>;
  getBacktestResult: (taskId: string) => Promise<void>;
  updateStrategyConfig: (config: Partial<StrategyConfig>) => void;
  validateConfig: () => Promise<ValidationResult>;
  clearBacktest: () => void;
}
```

## 4. API服务层设计

### 4.1 基础API配置 (api.ts)

```typescript
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.REACT_APP_API_BASE_URL || 'http://localhost:8000',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
api.interceptors.request.use(
  (config) => {
    // 添加认证token等
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器
api.interceptors.response.use(
  (response) => response.data,
  (error) => {
    // 统一错误处理
    const message = error.response?.data?.detail || error.message;
    return Promise.reject(new Error(message));
  }
);

export default api;
```

### 4.2 回测服务 (backtestService.ts)

```typescript
import api from './api';
import { BacktestRequest, BacktestResult, StrategyConfig, ValidationResult } from '../types';

export const backtestService = {
  // 获取策略模板
  async getStrategyTemplates() {
    return api.get('/api/strategy/templates');
  },

  // 验证策略配置
  async validateStrategy(config: StrategyConfig): Promise<ValidationResult> {
    return api.post('/api/strategy/validate', config);
  },

  // 启动回测
  async startBacktest(request: BacktestRequest): Promise<BacktestResult> {
    return api.post('/api/strategy/backtest', request);
  },

  // 获取回测结果
  async getBacktestResult(taskId: string): Promise<BacktestResult> {
    return api.get(`/api/strategy/backtest/${taskId}`);
  },

  // 获取回测列表
  async getBacktestList(): Promise<BacktestResult[]> {
    return api.get('/api/strategy/backtest');
  },
};
```

## 5. 关键功能实现

### 5.1 交易信号标记

**实现方案：**
- 在TradingView图表上添加自定义标记
- 不同信号类型使用不同颜色和图标
- 支持点击查看信号详情

**信号类型：**
- 开多：绿色向上箭头
- 开空：红色向下箭头
- 平多：黄色圆点
- 平空：橙色圆点

### 5.2 实时回测进度

**实现方案：**
- 使用轮询方式获取回测状态
- 进度条显示回测进度
- 状态变化时的UI反馈

### 5.3 数据可视化

**图表库选择：**
- K线图：TradingView Charting Library
- 资金曲线：Chart.js 或 Recharts
- 性能指标：Ant Design Charts

## 6. 性能优化策略

### 6.1 数据处理优化

- K线数据分页加载
- 虚拟滚动处理大量交易记录
- 图表数据缓存机制
- 防抖处理用户输入

### 6.2 组件优化

- React.memo 优化组件渲染
- useMemo 缓存计算结果
- useCallback 优化事件处理
- 代码分割和懒加载

### 6.3 网络优化

- API请求缓存
- 并发请求控制
- 错误重试机制
- 请求取消处理

## 7. 错误处理和用户体验

### 7.1 错误边界

- 全局错误边界组件
- 组件级错误处理
- 友好的错误提示
- 错误日志收集

### 7.2 加载状态

- 骨架屏加载效果
- 进度指示器
- 加载状态管理
- 超时处理机制

### 7.3 用户反馈

- 操作成功提示
- 表单验证反馈
- 警告信息展示
- 帮助文档集成

## 8. 测试策略

### 8.1 单元测试

- 组件渲染测试
- 状态管理测试
- 工具函数测试
- API服务测试

### 8.2 集成测试

- 页面交互测试
- API集成测试
- 端到端测试
- 性能测试

## 9. 部署和构建

### 9.1 构建优化

- 代码分割配置
- 资源压缩优化
- 缓存策略设置
- 环境变量配置

### 9.2 部署配置

- 静态资源部署
- CDN配置
- 域名和SSL设置
- 监控和日志配置