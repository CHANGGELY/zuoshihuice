# 前端重构执行计划

## 1. 重构概述

### 1.1 重构目标

* 简化前端架构，只保留两个核心页面

* 优化K线图表展示和策略回测功能

* 确保前端参数配置与后端API完全一致

* 提升用户体验和系统性能

### 1.2 技术栈确认

* **前端框架**: React 18 + TypeScript

* **构建工具**: Vite

* **UI组件库**: Ant Design

* **图表库**: TradingView Charting Library

* **状态管理**: Zustand

* **样式方案**: Tailwind CSS + Ant Design

* **HTTP客户端**: Axios

## 2. 执行步骤

### 阶段一：项目结构重构 (预计2小时)

#### 步骤1.1：清理现有代码

* 备份当前前端代码

* 删除不需要的页面和组件

* 保留核心的配置文件

#### 步骤1.2：重建目录结构

```bash
# 创建新的目录结构
mkdir -p src/{components/{common,charts,forms},pages,stores,services,types,utils,hooks,styles}
```

#### 步骤1.3：安装必要依赖

```bash
# 安装新增依赖
npm install zustand @ant-design/charts recharts
npm install -D @types/tradingview
```

### 阶段二：类型定义和API服务 (预计1.5小时)

#### 步骤2.1：创建类型定义文件

* `src/types/kline.ts` - K线数据类型

* `src/types/strategy.ts` - 策略配置类型

* `src/types/backtest.ts` - 回测结果类型

#### 步骤2.2：实现API服务层

* `src/services/api.ts` - 基础API配置

* `src/services/klineService.ts` - K线数据服务

* `src/services/backtestService.ts` - 回测服务

#### 步骤2.3：创建状态管理

* `src/stores/klineStore.ts` - K线数据状态

* `src/stores/backtestStore.ts` - 回测状态

* `src/stores/uiStore.ts` - UI状态

### 阶段三：核心组件开发 (预计4小时)

#### 步骤3.1：基础组件开发

* `src/components/common/Loading.tsx` - 加载组件

* `src/components/common/ErrorBoundary.tsx` - 错误边界

* `src/components/common/Header.tsx` - 页面头部

#### 步骤3.2：图表组件开发

* `src/components/charts/TradingViewChart.tsx` - TradingView图表

* `src/components/charts/EquityCurveChart.tsx` - 资金曲线图

* `src/components/charts/SignalMarkers.tsx` - 交易信号标记

#### 步骤3.3：表单组件开发

* `src/components/forms/StrategyConfigForm.tsx` - 策略配置表单

* `src/components/forms/DateRangePicker.tsx` - 日期范围选择器

### 阶段四：页面组件开发 (预计3小时)

#### 步骤4.1：K线图表页面

* 实现主要布局：左侧图表区域，右侧配置面板

* 集成TradingView图表组件

* 实现策略配置表单

* 添加回测控制功能

* 实现交易信号标记显示

#### 步骤4.2：回测结果页面

* 实现回测概览指标展示

* 集成资金曲线图表

* 实现交易记录表格

* 添加持仓历史可视化

### 阶段五：功能集成和优化 (预计2小时)

#### 步骤5.1：路由配置

* 配置React Router

* 实现页面导航

* 添加路由守卫

#### 步骤5.2：数据流集成

* 连接API服务和状态管理

* 实现数据缓存机制

* 添加错误处理逻辑

#### 步骤5.3：性能优化

* 实现组件懒加载

* 添加虚拟滚动

* 优化图表渲染性能

### 阶段六：测试和调试 (预计1.5小时)

#### 步骤6.1：功能测试

* 测试K线数据加载

* 测试策略配置和验证

* 测试回测流程

* 测试结果展示

#### 步骤6.2：兼容性测试

* 测试不同浏览器兼容性

* 测试响应式布局

* 测试移动端适配

#### 步骤6.3：性能测试

* 测试大数据量加载

* 测试图表渲染性能

* 测试内存使用情况

## 3. 关键实现细节

### 3.1 TradingView图表集成

**数据源配置：**

```typescript
const datafeed = {
  onReady: (callback) => {
    callback({
      supported_resolutions: ['1', '5', '15', '30', '60', '240', '1D'],
      supports_marks: true,
      supports_timescale_marks: true,
    });
  },
  
  resolveSymbol: (symbolName, onSymbolResolvedCallback) => {
    const symbolInfo = {
      name: symbolName,
      ticker: symbolName,
      description: symbolName,
      type: 'crypto',
      session: '24x7',
      timezone: 'Asia/Shanghai',
      exchange: 'Binance',
      minmov: 1,
      pricescale: 100,
      has_intraday: true,
      supported_resolutions: ['1', '5', '15', '30', '60', '240', '1D'],
      volume_precision: 2,
      data_status: 'streaming',
    };
    onSymbolResolvedCallback(symbolInfo);
  },
  
  getBars: async (symbolInfo, resolution, from, to, onHistoryCallback) => {
    try {
      const data = await klineService.getKlineData({
        symbol: symbolInfo.name,
        interval: resolution + 'm',
        start_time: new Date(from * 1000).toISOString(),
        end_time: new Date(to * 1000).toISOString(),
      });
      
      const bars = data.map(item => ({
        time: item.timestamp,
        open: item.open,
        high: item.high,
        low: item.low,
        close: item.close,
        volume: item.volume,
      }));
      
      onHistoryCallback(bars, { noData: bars.length === 0 });
    } catch (error) {
      onHistoryCallback([], { noData: true });
    }
  },
};
```

### 3.2 策略配置表单实现

**表单验证规则：**

```typescript
const validationRules = {
  name: [
    { required: true, message: '请输入策略名称' },
    { min: 2, max: 50, message: '策略名称长度为2-50个字符' },
  ],
  leverage: [
    { required: true, message: '请输入杠杆倍数' },
    { type: 'number', min: 1, max: 125, message: '杠杆倍数必须在1-125之间' },
  ],
  spread: [
    { required: true, message: '请输入价差' },
    { type: 'number', min: 0.001, max: 0.1, message: '价差必须在0.1%-10%之间' },
  ],
  initial_balance: [
    { required: true, message: '请输入初始资金' },
    { type: 'number', min: 100, message: '初始资金不能少于100 USDT' },
  ],
};
```

### 3.3 交易信号标记实现

**信号标记配置：**

```typescript
const signalMarkers = {
  open_long: {
    color: '#00c851',
    shape: 'arrowUp',
    position: 'belowBar',
    text: '开多',
  },
  open_short: {
    color: '#ff4444',
    shape: 'arrowDown',
    position: 'aboveBar',
    text: '开空',
  },
  close_long: {
    color: '#ffbb33',
    shape: 'circle',
    position: 'belowBar',
    text: '平多',
  },
  close_short: {
    color: '#ff8800',
    shape: 'circle',
    position: 'aboveBar',
    text: '平空',
  },
};
```

## 4. 风险控制和注意事项

### 4.1 数据安全

* API请求加密传输

* 敏感数据本地存储加密

* 防止XSS和CSRF攻击

### 4.2 性能风险

* 大量K线数据的内存管理

* 图表渲染性能优化

* 避免内存泄漏

### 4.3 用户体验

* 网络异常处理

* 加载状态提示

* 操作反馈机制

## 5. 验收标准

### 5.1 功能验收

* [ ] K线图表正常显示H5文件数据

* [ ] 策略配置表单参数与后端API一致

* [ ] 回测功能正常运行并显示结果

* [ ] 交易信号在图表上正确标记

* [ ] 回测结果页面完整展示所有指标

### 5.2 性能验收

* [ ] 页面首次加载时间 < 3秒

* [ ] K线图表渲染流畅，无卡顿

* [ ] 大量交易记录展示性能良好

* [ ] 内存使用稳定，无明显泄漏

### 5.3 兼容性验收

* [ ] Chrome、Firefox、Safari浏览器兼容

* [ ] 桌面端响应式布局正常

* [ ] 移动端基本功能可用

## 6. 后续优化计划

### 6.1 功能增强

* 添加更多策略类型支持

* 实现策略参数优化功能

* 增加风险指标分析

### 6.2 性能优化

* 实现WebSocket实时数据推送

* 优化图表渲染算法

* 添加数据预加载机制

### 6.3 用户体验

* 添加快捷键支持

* 实现个性化设置

* 增加帮助文档和教程

