# 技术架构决策记录 (ADR - Architecture Decision Records)

## ADR-001: ATR计算方法选择

**日期**: 2025-01-02  
**状态**: 已实施  
**决策者**: 量化交易专家团队

### 背景
原系统使用简单移动平均(SMA)计算ATR，在市场快速变化时响应较慢，可能错过关键的风控时机。

### 决策
将ATR计算从简单移动平均(SMA)改为指数移动平均(EMA)。

### 理由
1. **响应速度**: EMA对近期价格变化更敏感，能更快识别波动率变化
2. **风控效果**: 在市场突发波动时能更及时触发保护机制
3. **行业标准**: EMA是量化交易中更常用的技术指标计算方法
4. **参数调优**: α = 2/(period+1)的标准EMA公式，便于参数优化

### 实施细节
```python
# 原SMA方法
atr = sum(recent_trs) / len(recent_trs)

# 新EMA方法
self.ema_atr = self.alpha * true_range + (1 - self.alpha) * self.ema_atr
```

### 影响
- 提高了ATR计算的响应速度
- 改善了风控机制的及时性
- 保持了向后兼容性

---

## ADR-002: 前后端分离架构选型

**日期**: 2025-01-02  
**状态**: 规划中  
**决策者**: 全栈开发团队

### 背景
当前Python单体应用在用户体验、可扩展性和维护性方面存在限制，需要现代化的前后端分离架构。

### 决策
采用React + FastAPI的前后端分离架构。

### 技术栈选择

#### 前端: React
**理由**:
1. **生态成熟**: 丰富的图表库(Chart.js, D3.js)支持金融数据可视化
2. **性能优秀**: 虚拟DOM和组件化架构适合复杂交互
3. **实时更新**: 良好的WebSocket集成支持实时数据推送
4. **开发效率**: TypeScript支持提供类型安全

#### 后端: FastAPI
**理由**:
1. **性能卓越**: 基于Starlette和Pydantic，性能接近Node.js
2. **类型安全**: 原生支持Python类型提示，减少运行时错误
3. **API文档**: 自动生成OpenAPI文档，便于前端集成
4. **异步支持**: 原生async/await支持，适合高并发场景
5. **Python生态**: 可复用现有的量化计算代码

#### 数据库: PostgreSQL + TimescaleDB
**理由**:
1. **时序优化**: TimescaleDB专为时序数据设计，查询性能优秀
2. **ACID保证**: 确保金融数据的一致性和可靠性
3. **扩展性**: 支持水平分片，可处理大规模历史数据
4. **SQL兼容**: 标准SQL语法，学习成本低

#### 缓存: Redis
**理由**:
1. **内存性能**: 极快的读写速度，适合热点数据缓存
2. **数据结构**: 丰富的数据类型支持复杂缓存策略
3. **持久化**: 支持RDB和AOF，保证数据安全
4. **集群支持**: 可扩展到多节点集群

### 架构图
```
┌─────────────┐    HTTP/WebSocket    ┌─────────────┐
│   React     │ ◄─────────────────► │   FastAPI   │
│   Frontend  │                     │   Backend   │
└─────────────┘                     └─────────────┘
                                            │
                                            ▼
                                    ┌─────────────┐
                                    │   Redis     │
                                    │   Cache     │
                                    └─────────────┘
                                            │
                                            ▼
                                    ┌─────────────┐
                                    │ PostgreSQL  │
                                    │ TimescaleDB │
                                    └─────────────┘
```

### 迁移策略
1. **阶段一**: 搭建基础设施(数据库、API框架)
2. **阶段二**: 数据迁移和API开发
3. **阶段三**: React前端开发
4. **阶段四**: 集成测试和部署

---

## ADR-003: 数据存储策略

**日期**: 2025-01-02  
**状态**: 设计中  
**决策者**: 数据架构团队

### 背景
量化交易系统需要处理大量时序数据，对查询性能、数据完整性和存储效率有严格要求。

### 决策
采用分层存储策略：热数据(Redis) + 温数据(TimescaleDB) + 冷数据(对象存储)。

### 存储分层

#### 热数据层 (Redis)
- **数据类型**: 实时计算结果、会话状态、缓存数据
- **保留时间**: 1-7天
- **访问模式**: 高频读写
- **容量**: 内存限制，通常几GB

#### 温数据层 (TimescaleDB)
- **数据类型**: 历史K线、交易记录、回测结果
- **保留时间**: 1-5年
- **访问模式**: 中频查询，批量分析
- **容量**: TB级别

#### 冷数据层 (对象存储)
- **数据类型**: 原始数据备份、归档日志
- **保留时间**: 长期保存
- **访问模式**: 低频访问，主要用于备份恢复
- **容量**: PB级别

### 数据生命周期
```
实时数据 → Redis(热) → TimescaleDB(温) → 对象存储(冷)
    ↓           ↓              ↓
  秒级        小时级         月级
```

---

## ADR-004: API设计原则

**日期**: 2025-01-02  
**状态**: 设计中  
**决策者**: API设计团队

### 背景
需要设计RESTful API来支持前后端分离架构，确保API的可用性、可扩展性和安全性。

### 设计原则

#### 1. RESTful设计
- 使用标准HTTP方法(GET, POST, PUT, DELETE)
- 资源导向的URL设计
- 统一的响应格式

#### 2. 版本控制
- URL路径版本控制: `/api/v1/`
- 向后兼容性保证
- 渐进式升级策略

#### 3. 错误处理
- 标准HTTP状态码
- 详细的错误信息
- 错误码映射表

#### 4. 性能优化
- 分页查询支持
- 字段选择器
- 压缩传输
- 缓存策略

#### 5. 安全性
- JWT认证
- CORS配置
- 请求限流
- 输入验证

### API响应格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "timestamp": "2025-01-02T10:00:00Z",
  "request_id": "uuid"
}
```

---

## 决策评估标准

每个技术决策都基于以下标准进行评估：

1. **性能要求**: 是否满足量化交易的低延迟需求
2. **可扩展性**: 能否支持业务增长和数据量增加
3. **可维护性**: 代码质量和团队技能匹配度
4. **安全性**: 金融数据的安全保护能力
5. **成本效益**: 开发和运维成本的合理性
6. **技术风险**: 技术成熟度和社区支持

## 决策变更流程

1. **提出变更**: 识别需要变更的技术决策
2. **影响分析**: 评估变更对系统的影响范围
3. **方案设计**: 制定详细的变更方案
4. **团队评审**: 技术团队集体决策
5. **实施计划**: 制定分阶段实施计划
6. **文档更新**: 更新相关技术文档

---

*本文档将持续更新，记录项目中的重要技术决策和演进过程。*