# 对冲网格策略回测系统 - 项目核心信息

## 项目概述
- **项目名称**: 对冲网格策略回测系统
- **核心策略**: 对冲网格交易策略 + ATR波动率风控
- **技术栈**: Python + FastAPI + React (规划中)
- **数据源**: ETH-USDC 1小时K线数据

## 核心算法特性

### 1. ATR波动率监控
- **计算方法**: 指数移动平均(EMA)，响应速度更快
- **监控周期**: 1440分钟(24小时)
- **波动率等级**: NORMAL < 30%, HIGH 30-50%, EXTREME > 50%
- **风控机制**: ATR >= 30%时触发仓位平衡模式

### 2. 对冲网格策略
- **正常模式**: ATR < 30%时，每个价位同时开多空(对冲)
- **风控模式**: ATR >= 30%时，仓位平衡使净持仓趋向0
- **平仓机制**: 每次开仓都挂限价平仓单
- **止损保护**: 单笔仓位止损机制

### 3. 关键配置参数
```python
STRATEGY_CONFIG = {
    "leverage": 3,                    # 杠杆倍数
    "spread": 0.004,                 # 价差0.4%
    "atr_threshold": 0.30,           # ATR阈值30%
    "hedge_mode": True,              # 对冲模式
    "position_stop_loss": 0.05       # 止损5%
}

ATR_CONFIG = {
    "enable_volatility_adaptive": True,
    "high_volatility_threshold": 0.30,
    "extreme_volatility_threshold": 0.50,
    "enable_debug_output": True
}
```

## 项目文件结构

### 核心文件
- `backtest_kline_trajectory.py` - 主回测引擎
- `test_corrected_atr_logic.py` - ATR逻辑测试(最新版)
- `ATR配置完整说明.md` - ATR配置文档

### 数据文件
- `K线data/` - K线数据存储
- `cache/` - 预处理数据缓存

### 服务器文件
- `前端服务器.py` - 前端Web服务
- `后端回测服务器.py` - 后端API服务
- `数据预处理器.py` - 数据预处理

## 技术架构演进

### 当前架构
- Python单体应用
- 本地文件存储
- 简单Web界面

### 目标架构(React + FastAPI)
- 前后端分离
- PostgreSQL + TimescaleDB时序数据库
- Redis缓存层
- RESTful API + WebSocket实时通信

## 性能优化要点

### 1. ATR计算优化
- ✅ 使用EMA替代SMA，提高响应速度
- ✅ 调试输出按间隔控制，避免性能影响
- ✅ ATR统计信息实时更新

### 2. 回测引擎优化
- 向量化价格轨迹计算
- Decimal精度计算避免浮点误差
- 批量订单处理
- 内存缓存机制

### 3. 数据处理优化
- HDF5格式存储大数据集
- 预处理数据缓存
- 增量数据更新

## 关键决策记录

### 2025-01-02
1. **ATR计算方法**: 从简单移动平均改为指数移动平均，提高对市场变化的响应速度
2. **测试文件清理**: 保留`test_corrected_atr_logic.py`作为最新测试版本
3. **架构规划**: 确定React + FastAPI技术栈用于前后端分离重构

## 待完成任务
- [ ] 合并ATR配置文档
- [ ] 实现价格最劣优先平仓逻辑
- [ ] 完善限价平仓单机制
- [ ] 数据库架构设计与迁移
- [ ] React前端开发
- [ ] API接口设计与实现

## 风险控制要点
1. **爆仓保护**: 实时监控保证金率，低于维持保证金时强制平仓
2. **波动率保护**: ATR高于阈值时减少风险敞口
3. **止损机制**: 单笔仓位止损保护
4. **资金管理**: 动态调整仓位大小，控制单次风险敞口

## 性能指标
- **回测速度**: 优化后可处理大量历史数据
- **精度保证**: 使用Decimal避免浮点误差
- **内存效率**: 缓存机制减少重复计算
- **实时性**: EMA ATR计算提供快速响应