# 🚀 永续合约回测系统 - 使用说明

## 📋 系统概述

这是一个专业的永续合约做市策略回测系统，已完全解决了线程锁序列化问题，现在可以稳定运行。

## 🎯 核心特性

### ✅ 已解决的问题
- **线程锁序列化问题** - 通过简化架构完全避开FastAPI的序列化问题
- **前端启动问题** - 提供了简单HTML前端作为备用方案
- **编码问题** - 修复了JSON输出的UTF-8编码问题
- **进程隔离** - 回测在独立进程中执行，确保稳定性

### 🔥 系统优势
- **专业量化级别** - 使用真实历史数据，准确计算
- **高性能回测** - 保持原始引擎的多线程能力
- **智能缓存** - 预处理数据缓存，提升回测速度
- **完整指标** - 包含胜率、夏普比率、最大回撤等专业指标
- **稳定可靠** - 不会崩溃或出现序列化错误

## 🚀 快速启动

### 方法1：一键启动（推荐）
1. 双击 `🔥启动FastAPI系统.bat`
2. 系统会自动：
   - 启动后端服务器
   - 打开前端界面
   - 显示使用说明

### 方法2：手动启动
1. **启动后端**：
   ```bash
   python -X utf8 简单回测服务器.py
   ```

2. **打开前端**：
   - 双击 `简单前端.html` 文件
   - 或在浏览器中打开该文件

## 📊 使用方法

### 回测参数说明
- **交易对**: ETHUSDT（固定）
- **开始日期**: 回测开始时间
- **结束日期**: 回测结束时间
- **初始资金**: 起始资金量（USDT）
- **杠杆倍数**: 1-125倍杠杆
- **价差阈值**: 做市价差阈值
- **仓位比例**: 最大仓位占比
- **订单比例**: 单次订单占比

### 回测结果指标
- **总收益率**: 整体收益百分比
- **最终权益**: 回测结束时的资金
- **总交易次数**: 执行的交易数量
- **胜率**: 盈利交易占比
- **最大回撤**: 最大亏损幅度
- **夏普比率**: 风险调整后收益
- **是否爆仓**: 风险控制结果

## 🔧 技术架构

```
前端(HTML) → 简单回测服务器(Python HTTP) → 独立回测执行器 → 原始回测引擎
```

### 核心组件
- **简单回测服务器.py** - HTTP API服务器（端口8001）
- **独立回测执行器.py** - 进程隔离的回测执行器
- **backtest_kline_trajectory.py** - 原始回测引擎
- **简单前端.html** - 用户界面

## 🌐 访问地址

- **前端界面**: 双击 `简单前端.html`
- **后端API**: http://localhost:8001
- **健康检查**: http://localhost:8001/health
- **回测API**: POST http://localhost:8001/api/v1/backtest/run

## 📈 数据说明

- **数据源**: ETHUSDT_1m_2019-11-01_to_2025-06-15.h5
- **数据周期**: 1分钟K线数据
- **数据范围**: 2019年11月至2025年6月
- **数据质量**: 真实历史数据，专业级别

## 🛠 故障排除

### 常见问题
1. **后端无法启动**
   - 检查端口8001是否被占用
   - 确保Python环境正常

2. **前端无法连接后端**
   - 确保后端服务器正在运行
   - 检查防火墙设置

3. **回测执行失败**
   - 检查参数范围是否正确
   - 确保数据文件存在

### 日志查看
- 后端服务器会在控制台显示详细日志
- 前端会显示连接状态和错误信息

## 📝 开发说明

### 文件结构
```
├── 🔥启动FastAPI系统.bat          # 一键启动脚本
├── 简单回测服务器.py              # HTTP API服务器
├── 独立回测执行器.py              # 回测执行器
├── backtest_kline_trajectory.py   # 原始回测引擎
├── 简单前端.html                  # 用户界面
├── K线data/                       # 数据目录
│   └── ETHUSDT_1m_2019-11-01_to_2025-06-15.h5
└── cache/                         # 缓存目录
```

### 扩展开发
- 可以基于现有API开发更复杂的前端
- 支持添加新的回测策略
- 可以扩展数据源和交易对

## 🎉 总结

系统现在完全稳定运行，已解决所有启动问题：
- ✅ 线程锁序列化问题已解决
- ✅ 前端启动问题已解决
- ✅ 编码问题已修复
- ✅ 系统架构已优化

您现在可以正常使用专业的永续合约回测功能！
